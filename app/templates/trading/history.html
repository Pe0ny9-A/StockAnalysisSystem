{% extends "base.html" %}

{% block title %}交易历史{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('portfolio.index') }}">投资组合</a></li>
            {% if portfolio %}
            <li class="breadcrumb-item"><a href="{{ url_for('portfolio.detail', portfolio_id=portfolio.id) }}">{{ portfolio.name }}</a></li>
            {% endif %}
            {% if stock %}
            <li class="breadcrumb-item"><a href="{{ url_for('stock.detail', code=stock.code) }}">{{ stock.name }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active">交易历史</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                交易历史
                {% if portfolio %}
                - {{ portfolio.name }}
                {% endif %}
                {% if stock %}
                - {{ stock.name }} ({{ stock.code }})
                {% endif %}
            </h4>
            <div class="btn-group">
                <a href="{{ url_for('trading.buy') }}" class="btn btn-success btn-sm">
                    <i class="fas fa-plus-circle"></i> 买入股票
                </a>
                <a href="{{ url_for('trading.sell') }}" class="btn btn-danger btn-sm">
                    <i class="fas fa-minus-circle"></i> 卖出股票
                </a>
            </div>
        </div>
        <div class="card-body">
            <!-- 过滤条件 -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <form class="row g-3" method="GET" action="{{ url_for('trading.history') }}">
                        <div class="col-md-3">
                            <label for="portfolio_id" class="form-label">投资组合</label>
                            <select class="form-select" id="portfolio_id" name="portfolio_id">
                                <option value="">全部</option>
                                {% for p in portfolios %}
                                <option value="{{ p.id }}" {% if request.args.get('portfolio_id') == p.id|string or (portfolio and portfolio.id == p.id) %}selected{% endif %}>
                                    {{ p.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="stock_code" class="form-label">股票</label>
                            <input type="text" class="form-control" id="stock_code" name="stock_code" 
                                   placeholder="代码或名称" value="{{ request.args.get('stock_code', '') or (stock.code if stock else '') }}">
                        </div>
                        <div class="col-md-2">
                            <label for="transaction_type" class="form-label">交易类型</label>
                            <select class="form-select" id="transaction_type" name="transaction_type">
                                <option value="">全部</option>
                                <option value="BUY" {% if request.args.get('transaction_type') == 'BUY' %}selected{% endif %}>买入</option>
                                <option value="SELL" {% if request.args.get('transaction_type') == 'SELL' %}selected{% endif %}>卖出</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="date_from" class="form-label">开始日期</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" 
                                   value="{{ request.args.get('date_from', '') }}">
                        </div>
                        <div class="col-md-2">
                            <label for="date_to" class="form-label">结束日期</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" 
                                   value="{{ request.args.get('date_to', '') }}">
                        </div>
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter"></i> 筛选
                            </button>
                            <a href="{{ url_for('trading.history') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-redo"></i> 重置
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 交易记录表格 -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>交易日期</th>
                            <th>股票代码</th>
                            <th>股票名称</th>
                            <th>交易类型</th>
                            <th>价格</th>
                            <th>数量</th>
                            <th>交易金额</th>
                            <th>手续费</th>
                            <th>投资组合</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable">
                        {% if transactions %}
                            {% for transaction in transactions %}
                            <tr>
                                <td>{{ transaction.executed_at }}</td>
                                <td>{{ transaction.stock_code }}</td>
                                <td>
                                    <a href="{{ url_for('stock.detail', code=transaction.stock_code) }}">
                                        {{ transaction.stock_name }}
                                    </a>
                                </td>
                                <td class="{{ 'text-success' if transaction.transaction_type == 'BUY' else 'text-danger' }}">
                                    {{ '买入' if transaction.transaction_type == 'BUY' else '卖出' }}
                                </td>
                                <td>{{ transaction.price }}</td>
                                <td>{{ transaction.quantity }}</td>
                                <td>{{ transaction.total_amount }}</td>
                                <td>{{ transaction.commission or '0.00' }}</td>
                                <td>
                                    <a href="{{ url_for('portfolio.detail', portfolio_id=transaction.portfolio_id) }}">
                                        {{ transaction.portfolio_name }}
                                    </a>
                                </td>
                                <td>{{ transaction.note or '' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-primary view-transaction-btn" 
                                                data-transaction-id="{{ transaction.id }}">
                                            查看
                                        </button>
                                        <button type="button" class="btn btn-outline-danger delete-transaction-btn" 
                                                data-transaction-id="{{ transaction.id }}" 
                                                data-transaction-type="{{ transaction.transaction_type }}"
                                                data-stock-name="{{ transaction.stock_name }}"
                                                data-quantity="{{ transaction.quantity }}">
                                            删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="11" class="text-center py-3">
                                    暂无交易记录
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- 分页 -->
            {% if pagination and pagination.pages > 1 %}
            <nav aria-label="交易记录分页">
                <ul class="pagination justify-content-center">
                    <li class="page-item {{ 'disabled' if pagination.page == 1 else '' }}">
                        <a class="page-link" href="{{ url_for('trading.history', page=pagination.page-1, **request.args) }}" aria-label="上一页">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    
                    {% for p in range(1, pagination.pages + 1) %}
                        {% if p == 1 or p == pagination.pages or (p >= pagination.page - 2 and p <= pagination.page + 2) %}
                            <li class="page-item {{ 'active' if p == pagination.page else '' }}">
                                <a class="page-link" href="{{ url_for('trading.history', page=p, **request.args) }}">{{ p }}</a>
                            </li>
                        {% elif p == 2 or p == pagination.pages - 1 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    <li class="page-item {{ 'disabled' if pagination.page == pagination.pages else '' }}">
                        <a class="page-link" href="{{ url_for('trading.history', page=pagination.page+1, **request.args) }}" aria-label="下一页">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- 交易详情模态框 -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel">交易详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="transactionDetails">
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mb-0 mt-2">加载交易详情...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除此交易记录吗？此操作不可恢复。</p>
                <div class="alert alert-warning">
                    <p class="mb-0"><strong>警告：</strong>删除交易记录将会影响对应投资组合的持仓数据。</p>
                    <ul class="mb-0 mt-1">
                        <li id="deleteWarning"></li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 查看交易详情
        const viewBtns = document.querySelectorAll('.view-transaction-btn');
        const transactionModal = new bootstrap.Modal(document.getElementById('transactionModal'));
        const transactionDetails = document.getElementById('transactionDetails');
        
        viewBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const transactionId = this.dataset.transactionId;
                
                // 显示加载状态
                transactionDetails.innerHTML = `
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mb-0 mt-2">加载交易详情...</p>
                    </div>
                `;
                
                transactionModal.show();
                
                // 获取交易详情
                fetch(`/trading/api/transactions/${transactionId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const transaction = data.data;
                            
                            const html = `
                                <dl class="row mb-0">
                                    <dt class="col-sm-4">交易类型</dt>
                                    <dd class="col-sm-8 ${transaction.transaction_type === 'BUY' ? 'text-success' : 'text-danger'}">
                                        ${transaction.transaction_type === 'BUY' ? '买入' : '卖出'}
                                    </dd>
                                    
                                    <dt class="col-sm-4">股票</dt>
                                    <dd class="col-sm-8">${transaction.stock_name} (${transaction.stock_code})</dd>
                                    
                                    <dt class="col-sm-4">交易日期</dt>
                                    <dd class="col-sm-8">${transaction.executed_at}</dd>
                                    
                                    <dt class="col-sm-4">交易价格</dt>
                                    <dd class="col-sm-8">${transaction.price}元/股</dd>
                                    
                                    <dt class="col-sm-4">交易数量</dt>
                                    <dd class="col-sm-8">${transaction.quantity}股</dd>
                                    
                                    <dt class="col-sm-4">交易金额</dt>
                                    <dd class="col-sm-8">${transaction.total_amount}元</dd>
                                    
                                    <dt class="col-sm-4">手续费</dt>
                                    <dd class="col-sm-8">${transaction.commission || '0.00'}元</dd>
                                    
                                    <dt class="col-sm-4">投资组合</dt>
                                    <dd class="col-sm-8">${transaction.portfolio_name}</dd>
                                    
                                    <dt class="col-sm-4">备注</dt>
                                    <dd class="col-sm-8">${transaction.note || '无'}</dd>
                                    
                                    <dt class="col-sm-4">创建时间</dt>
                                    <dd class="col-sm-8">${transaction.created_at}</dd>
                                </dl>
                            `;
                            
                            transactionDetails.innerHTML = html;
                        } else {
                            transactionDetails.innerHTML = `
                                <div class="alert alert-danger mb-0">
                                    获取交易详情失败: ${data.message || '请稍后重试'}
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('获取交易详情失败:', error);
                        transactionDetails.innerHTML = `
                            <div class="alert alert-danger mb-0">
                                获取交易详情失败，请刷新页面重试
                            </div>
                        `;
                    });
            });
        });
        
        // 删除交易记录
        const deleteBtns = document.querySelectorAll('.delete-transaction-btn');
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        const deleteWarning = document.getElementById('deleteWarning');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        
        deleteBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const transactionId = this.dataset.transactionId;
                const transactionType = this.dataset.transactionType;
                const stockName = this.dataset.stockName;
                const quantity = this.dataset.quantity;
                
                // 设置警告信息
                if (transactionType === 'BUY') {
                    deleteWarning.textContent = `删除此买入记录可能导致持仓减少${quantity}股${stockName}`;
                } else {
                    deleteWarning.textContent = `删除此卖出记录可能导致持仓增加${quantity}股${stockName}`;
                }
                
                // 设置确认按钮的数据
                confirmDeleteBtn.dataset.transactionId = transactionId;
                
                deleteModal.show();
            });
        });
        
        // 确认删除
        confirmDeleteBtn.addEventListener('click', function() {
            const transactionId = this.dataset.transactionId;
            
            fetch(`/trading/api/transactions/${transactionId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('交易记录删除成功');
                    deleteModal.hide();
                    location.reload();
                } else {
                    alert('删除失败: ' + (data.message || '请稍后重试'));
                }
            })
            .catch(error => {
                console.error('删除交易记录失败:', error);
                alert('删除失败，请稍后重试');
            });
        });
    });
</script>
{% endblock %} 