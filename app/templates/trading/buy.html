{% extends "base.html" %}

{% block title %}买入股票{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('portfolio.index') }}">投资组合</a></li>
            {% if portfolio %}
            <li class="breadcrumb-item"><a href="{{ url_for('portfolio.detail', portfolio_id=portfolio.id) }}">{{ portfolio.name }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active">买入股票</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">买入股票</h4>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('trading.buy') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- 选择股票 -->
                <div class="mb-4">
                    <h5>选择股票</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stock_code" class="form-label">股票代码 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="stock_code" name="stock_code" 
                                           value="{{ stock.code if stock else request.args.get('stock_code', '') }}" required>
                                    <button class="btn btn-outline-secondary" type="button" id="searchStockBtn">查询</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stock_name" class="form-label">股票名称</label>
                                <input type="text" class="form-control" id="stock_name" name="stock_name" 
                                       value="{{ stock.name if stock else '' }}" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="stockInfoSection" class="mb-4 {% if not stock %}d-none{% endif %}">
                    <div class="card bg-light">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6 class="mb-1">最新价</h6>
                                    <h5 class="mb-0" id="currentPrice">{{ stock.price|default('--', true) }}</h5>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="mb-1">涨跌幅</h6>
                                    <h5 class="mb-0 {% if stock and stock.change_percent and stock.change_percent > 0 %}text-success{% elif stock and stock.change_percent and stock.change_percent < 0 %}text-danger{% endif %}" id="changePercent">
                                        {% if stock and stock.change_percent %}
                                            {{ stock.change_percent }}%
                                        {% else %}
                                            --
                                        {% endif %}
                                    </h5>
                                </div>
                                <div class="col-md-4">
                                    <a href="{{ url_for('stock.detail', code=stock.code) if stock else '#' }}" class="btn btn-sm btn-outline-primary" id="viewDetailBtn"
                                       {% if not stock %}disabled{% endif %}>
                                        查看详情
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 交易信息 -->
                <div class="mb-4">
                    <h5>交易信息</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="portfolio_id" class="form-label">投资组合 <span class="text-danger">*</span></label>
                                <select class="form-select" id="portfolio_id" name="portfolio_id" required>
                                    <option value="">选择投资组合</option>
                                    {% for p in portfolios %}
                                    <option value="{{ p.id }}" {% if portfolio and portfolio.id == p.id %}selected{% elif request.args.get('portfolio_id') == p.id|string %}selected{% elif p.is_default and not portfolio %}selected{% endif %}>
                                        {{ p.name }} {% if p.is_default %}(默认){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="price" class="form-label">买入价格 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="price" name="price" 
                                           step="0.01" min="0.01" value="{{ stock.price|default('', true) }}" required>
                                    <span class="input-group-text">元</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">买入数量 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="quantity" name="quantity" 
                                           min="100" step="100" value="100" required>
                                    <span class="input-group-text">股</span>
                                </div>
                                <div class="form-text">A股最低交易单位为100股</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="total" class="form-label">交易金额</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="total" readonly>
                                    <span class="input-group-text">元</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 额外信息 -->
                <div class="mb-4">
                    <h5>额外信息</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="commission" class="form-label">手续费</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="commission" name="commission" 
                                           step="0.01" min="0" value="0">
                                    <span class="input-group-text">元</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="executed_at" class="form-label">交易日期</label>
                                <input type="date" class="form-control" id="executed_at" name="executed_at" 
                                       value="{{ today }}">
                                <div class="form-text">默认为今天，可修改为历史交易日期</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="note" class="form-label">交易备注</label>
                        <textarea class="form-control" id="note" name="note" rows="2"></textarea>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <a href="javascript:history.back()" class="btn btn-outline-secondary">返回</a>
                    <button type="submit" class="btn btn-success">确认买入</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const stockCodeInput = document.getElementById('stock_code');
        const stockNameInput = document.getElementById('stock_name');
        const searchStockBtn = document.getElementById('searchStockBtn');
        const stockInfoSection = document.getElementById('stockInfoSection');
        const currentPriceElem = document.getElementById('currentPrice');
        const changePercentElem = document.getElementById('changePercent');
        const viewDetailBtn = document.getElementById('viewDetailBtn');
        const priceInput = document.getElementById('price');
        const quantityInput = document.getElementById('quantity');
        const totalInput = document.getElementById('total');
        
        // 搜索股票
        searchStockBtn.addEventListener('click', function() {
            const stockCode = stockCodeInput.value.trim();
            if (!stockCode) {
                alert('请输入股票代码');
                return;
            }
            
            // 清除之前的股票信息
            stockNameInput.value = '';
            currentPriceElem.textContent = '--';
            changePercentElem.textContent = '--';
            changePercentElem.className = 'mb-0';
            viewDetailBtn.href = '#';
            viewDetailBtn.disabled = true;
            priceInput.value = '';
            
            // 显示加载状态
            stockInfoSection.classList.remove('d-none');
            currentPriceElem.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">加载中...</span></div>';
            
            // 获取股票信息
            fetch(`/stock/api/stocks/${stockCode}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const stock = data.data;
                        
                        stockNameInput.value = stock.name;
                        currentPriceElem.textContent = stock.price;
                        
                        if (stock.change_percent > 0) {
                            changePercentElem.textContent = `+${stock.change_percent}%`;
                            changePercentElem.className = 'mb-0 text-success';
                        } else if (stock.change_percent < 0) {
                            changePercentElem.textContent = `${stock.change_percent}%`;
                            changePercentElem.className = 'mb-0 text-danger';
                        } else {
                            changePercentElem.textContent = '0.00%';
                            changePercentElem.className = 'mb-0';
                        }
                        
                        viewDetailBtn.href = `/stock/detail/${stockCode}`;
                        viewDetailBtn.disabled = false;
                        
                        priceInput.value = stock.price;
                        
                        // 计算总金额
                        calculateTotal();
                    } else {
                        alert('找不到该股票: ' + data.message);
                        stockInfoSection.classList.add('d-none');
                    }
                })
                .catch(error => {
                    console.error('获取股票信息失败:', error);
                    alert('获取股票信息失败，请稍后重试');
                    stockInfoSection.classList.add('d-none');
                });
        });
        
        // 计算总金额
        function calculateTotal() {
            const price = parseFloat(priceInput.value) || 0;
            const quantity = parseInt(quantityInput.value) || 0;
            const total = price * quantity;
            totalInput.value = total.toFixed(2);
        }
        
        // 监听价格和数量变化，重新计算总金额
        priceInput.addEventListener('input', calculateTotal);
        quantityInput.addEventListener('input', calculateTotal);
        
        // 初始计算总金额
        calculateTotal();
    });
</script>
{% endblock %} 